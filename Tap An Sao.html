<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An Sao Tử Vi</title>
    <!-- Tailwind CSS cho Giao diện -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Thư viện xuất PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Thêm Google Font để khắc phục triệt để lỗi hiển thị dấu Tiếng Việt -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    
    <style>
        /* Ép toàn bộ trang web sử dụng font Noto Serif chuẩn Tiếng Việt */
        body { font-family: 'Noto Serif', serif !important; }

        @page { size: landscape; margin: 0; }
        @media print {
            .no-print { display: none !important; }
            body { background: #fdfcf0; padding: 0; margin: 0; }
            
            /* Ép buộc trình duyệt chỉ hiển thị Tab Lá Số khi sử dụng lệnh In gốc của trình duyệt */
            #tab-chart { display: flex !important; }
            #tab-converter { display: none !important; }
            
            .chart-container { 
                box-shadow: none !important; border: 2px solid black !important;
                width: 100vw !important; height: 100vh !important;
                position: absolute; top: 0; left: 0; transform: scale(1) !important;
            }
            .border-b { border-bottom: none !important; }
            /* Ẩn placeholder khi in */
            ::placeholder { color: transparent !important; }
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        input::placeholder, textarea::placeholder { color: #cbd5e1; font-style: italic; font-weight: normal; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Chỉnh lại con trỏ cho input có datalist để người dùng biết có thể xổ xuống */
        input[list] { cursor: pointer; }
        input[list]:focus { cursor: text; }
    </style>
</head>
<!-- Đã xóa class 'font-serif' mặc định của Tailwind để tránh xung đột -->
<body class="h-screen w-screen overflow-hidden bg-[#f4f1ea] p-2 sm:p-4 text-slate-900 flex flex-col box-border">

    <!-- Navigation Bar -->
    <div class="w-full max-w-[1200px] mx-auto mb-2 no-print shrink-0 flex-none z-20">
        <div class="flex flex-wrap gap-4 items-center justify-between bg-[#fdfcf0] p-3 rounded-xl shadow-sm border border-gray-200">
            <div class="flex items-center gap-6">
                <h1 class="text-xl font-bold text-red-900 uppercase tracking-tighter">An Sao Tử Vi</h1>
                <nav class="flex bg-[#f4f1ea] p-1 rounded-lg">
                    <button id="btn-tab-chart" onclick="switchTab('chart')" class="flex items-center gap-2 px-5 py-2 rounded-lg transition-all bg-[#fdfcf0] shadow text-red-800 font-bold">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Lá Số
                    </button>
                    <button id="btn-tab-converter" onclick="switchTab('converter')" class="flex items-center gap-2 px-5 py-2 rounded-lg transition-all text-gray-500 hover:text-gray-700">
                        <i data-lucide="arrow-right-left" class="w-5 h-5"></i> Đổi Lịch
                    </button>
                </nav>
            </div>
            <div class="flex gap-2">
                <button id="btn-print" onclick="triggerPrint()" class="flex items-center gap-2 bg-red-800 hover:bg-red-900 text-white px-5 py-2 rounded-lg transition-all shadow-md">
                    <i data-lucide="printer" class="w-5 h-5"></i> Xuất PDF
                </button>
                <button onclick="showResetModal()" class="flex items-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg border border-gray-200 font-bold">
                    <i data-lucide="rotate-ccw" class="w-5 h-5"></i> Làm mới
                </button>
            </div>
        </div>
    </div>

    <!-- TAB 1: LÁ SỐ -->
    <div id="tab-chart" class="flex-1 w-full relative z-10 flex">
        <div id="chart-wrapper" class="absolute inset-0 flex items-center justify-center overflow-hidden">
            <div id="export-area" class="bg-[#fdfcf0] border-2 border-black absolute shrink-0 shadow-2xl transition-transform duration-75 chart-container" style="width: 1200px; height: 848.5px; transform-origin: center;">
                <div id="chart-grid" class="grid grid-cols-4 grid-rows-4 h-full w-full gap-0 border-collapse">
                    <!-- Nội dung sẽ được vẽ bằng JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: ĐỔI LỊCH -->
    <div id="tab-converter" class="hidden flex-1 w-full overflow-y-auto no-print z-10">
        <div class="max-w-[1200px] mx-auto pb-10 pt-2">
            <div class="bg-[#fdfcf0] rounded-2xl shadow-xl p-8 border border-gray-200 mt-4">
                <div class="flex items-center gap-4 mb-10 border-b pb-6 text-red-800">
                    <div class="p-3 bg-red-100 rounded-2xl">
                        <i data-lucide="calendar" class="w-8 h-8"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold tracking-tight">Công cụ Chuyển đổi Lịch Thiên Văn</h2>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                    <div class="space-y-8">
                        <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2 underline underline-offset-8 decoration-red-200">1. Nhập Dương Lịch</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Ngày</label>
                                <input id="solar_day" type="number" class="w-full border-2 border-gray-100 rounded-xl p-4 text-xl font-bold focus:border-red-500 focus:bg-red-50/20 outline-none transition-all" oninput="handleSolarInput('day', this.value)">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Tháng</label>
                                <input id="solar_month" type="number" class="w-full border-2 border-gray-100 rounded-xl p-4 text-xl font-bold focus:border-red-500 focus:bg-red-50/20 outline-none transition-all" oninput="handleSolarInput('month', this.value)">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Năm</label>
                                <input id="solar_year" type="number" class="w-full border-2 border-gray-100 rounded-xl p-4 text-xl font-bold focus:border-red-500 focus:bg-red-50/20 outline-none transition-all" oninput="handleSolarInput('year', this.value)">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Khung Giờ Sinh</label>
                            <select id="solar_hour" class="w-full border-2 border-gray-100 rounded-xl p-4 text-lg font-bold focus:border-red-500 outline-none transition-all bg-[#fdfcf0]" onchange="handleSolarInput('hourIndex', this.value)">
                            </select>
                        </div>
                    </div>

                    <div class="space-y-8 bg-gradient-to-br from-red-50 to-orange-50 p-8 rounded-3xl border border-red-100 shadow-inner">
                        <h3 class="font-bold text-lg text-red-900 flex items-center gap-2 underline underline-offset-8 decoration-red-300">2. Kết quả Âm Lịch</h3>
                        <div class="space-y-5">
                            <div class="flex justify-between items-center border-b border-red-200 pb-3">
                                <span class="text-red-700/70 font-medium">Năm (Can Chi):</span>
                                <span id="res_canChiYear" class="text-2xl font-black text-red-800">---</span>
                            </div>
                            <div class="flex justify-between items-center border-b border-red-200 pb-3">
                                <span class="text-red-700/70 font-medium">Tháng:</span>
                                <span id="res_canChiMonth" class="text-xl font-black text-red-800">---</span>
                            </div>
                            <div class="flex justify-between items-center border-b border-red-200 pb-3">
                                <span class="text-red-700/70 font-medium">Ngày (Can Chi):</span>
                                <span id="res_canChiDay" class="text-xl font-black text-red-800">---</span>
                            </div>
                            <div class="flex justify-between items-center border-b border-red-200 pb-3">
                                <span class="text-red-700/70 font-medium">Giờ (Địa Chi):</span>
                                <span id="res_gioChi" class="text-xl font-black text-red-800">---</span>
                            </div>
                        </div>

                        <button onclick="applyToChart()" class="w-full mt-4 bg-red-800 hover:bg-red-900 text-white font-bold py-5 rounded-2xl shadow-lg flex items-center justify-center gap-3 transition-all active:scale-[0.98] uppercase tracking-widest text-sm">
                            <i data-lucide="check-circle-2" class="w-6 h-6"></i> Cập nhật vào lá số
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL XÁC NHẬN -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center no-print">
        <div class="bg-[#fdfcf0] p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-4 text-center transform transition-all">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600">
                <i data-lucide="alert-triangle" class="w-8 h-8"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Xác nhận làm mới</h3>
            <p class="text-gray-600 mb-6 text-sm">Bạn có chắc chắn muốn xóa toàn bộ dữ liệu lá số không? Thao tác này không thể hoàn tác.</p>
            <div class="flex justify-center gap-3">
                <button onclick="closeModal()" class="flex-1 px-4 py-2.5 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold transition-all">Hủy</button>
                <button onclick="executeReset()" class="flex-1 px-4 py-2.5 rounded-xl bg-red-600 hover:bg-red-700 text-white font-semibold transition-all">Xóa dữ liệu</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. HẰNG SỐ & THUẬT TOÁN ---
        const CAN = ["Giáp", "Ất", "Bính", "Đinh", "Mậu", "Kỷ", "Canh", "Tân", "Nhâm", "Quý"];
        const CHI = ["Tý", "Sửu", "Dần", "Mão", "Thìn", "Tỵ", "Ngọ", "Mùi", "Thân", "Dậu", "Tuất", "Hợi"];
        const GIO_CHI = ["Tý", "Sửu", "Dần", "Mão", "Thìn", "Tỵ", "Ngọ", "Mùi", "Thân", "Dậu", "Tuất", "Hợi"];
        const GIO_FRAMES = [
            "Tý (23h-1h)", "Sửu (1h-3h)", "Dần (3h-5h)", "Mão (5h-7h)", 
            "Thìn (7h-9h)", "Tỵ (9h-11h)", "Ngọ (11h-13h)", "Mùi (13h-15h)", 
            "Thân (15h-17h)", "Dậu (17h-19h)", "Tuất (19h-21h)", "Hợi (21h-23h)"
        ];
        const branches = ["Dần", "Mão", "Thìn", "Tỵ", "Ngọ", "Mùi", "Thân", "Dậu", "Tuất", "Hợi", "Tý", "Sửu"];
        
        // Cấu hình các Tùy chọn cho Dropdown
        const PALACE_NAMES = ["Mệnh", "Phụ Mẫu", "Phúc Đức", "Điền Trạch", "Quan Lộc", "Nô Bộc", "Thiên Di", "Tật Ách", "Tài Bạch", "Tử Tức", "Thê Thiếp", "Huynh Đệ"];
        const MAIN_STARS = ["Tử Vi", "Liêm Trinh", "Thiên Đồng", "Vũ Khúc", "Thái Dương", "Thiên Cơ", "Thiên Phủ", "Thái Âm", "Tham Lang", "Cự Môn", "Thiên Tướng", "Thiên Lương", "Thất Sát", "Phá Quân"];
        
        const gridPositions = [
            { row: 4, col: 1 }, { row: 3, col: 1 }, { row: 2, col: 1 }, { row: 1, col: 1 },
            { row: 1, col: 2 }, { row: 1, col: 3 }, { row: 1, col: 4 }, { row: 2, col: 4 },
            { row: 3, col: 4 }, { row: 4, col: 4 }, { row: 4, col: 3 }, { row: 4, col: 2 }
        ];

        const PI = Math.PI;
        function INT(d) { return Math.floor(d); }

        function getJulianDay(d, m, y) {
            let a = INT((14 - m) / 12);
            let yy = y + 4800 - a;
            let mm = m + 12 * a - 3;
            let jd = d + INT((153 * mm + 2) / 5) + 365 * yy + INT(yy / 4) - INT(yy / 100) + INT(yy / 400) - 32045;
            if (jd < 2299161) jd = d + INT((153 * mm + 2) / 5) + 365 * yy + INT(yy / 4) - 32083;
            return jd;
        }

        function getNewMoonDay(k, timeZone) {
            let T = k / 1236.85; let T2 = T * T; let T3 = T2 * T;
            let dr = Math.PI / 180;
            let Jd1 = 2415020.75933 + 29.53058868 * k + 0.0001178 * T2 - 0.000000155 * T3;
            let M = (2.973419 + 35999.050340 * T - 0.0001536 * T2) * dr;
            let Mprime = (315.653184 + 477198.867566 * T + 0.008997 * T2) * dr;
            let F = (160.710849 + 390670.502758 * T - 0.001614 * T2) * dr;
            let Omega = (259.183275 - 1934.136261 * T + 0.002078 * T2) * dr;

            let Jd2 = Jd1 - 0.40720 * Math.sin(Mprime) + 0.17241 * Math.sin(M)
                + 0.01608 * Math.sin(2 * Mprime) + 0.01039 * Math.sin(2 * F)
                + 0.00739 * Math.sin(Mprime - M) - 0.00514 * Math.sin(Mprime + M)
                + 0.00208 * Math.sin(2 * M) - 0.00111 * Math.sin(Mprime - 2 * F)
                - 0.00057 * Math.sin(Mprime + 2 * F) + 0.00056 * Math.sin(2 * Mprime + M)
                - 0.00042 * Math.sin(3 * Mprime) + 0.00042 * Math.sin(M + 2 * F)
                + 0.00038 * Math.sin(M - 2 * F) - 0.00024 * Math.sin(Omega);
            return INT(Jd2 + 0.5 + timeZone / 24);
        }

        function getSunLongitude(jdn, timeZone) {
            let T = (jdn - 2451545.0 - timeZone / 24) / 36525.0; let T2 = T * T;
            let dr = Math.PI / 180;
            let M = (357.52910 + 35999.05030 * T - 0.0001536 * T2 + T2 * T / 24490000) * dr;
            let L = 280.46646 + 36000.76983 * T + 0.0003032 * T2;
            let C = (1.914602 - 0.004817 * T - 0.000014 * T2) * Math.sin(M) 
                  + (0.019993 - 0.000101 * T) * Math.sin(2 * M) + 0.000289 * Math.sin(3 * M);
            let lambda = L + C; let a = INT(lambda / 360);
            return INT((lambda - a * 360) / 30); 
        }

        function getLunarMonth11(yy, timeZone) {
            let off = getJulianDay(31, 12, yy) - 2415021.076998695;
            let k = INT(off / 29.530588853);
            let monthStart = getNewMoonDay(k, timeZone);
            let sunLong = getSunLongitude(monthStart, timeZone);
            if (sunLong >= 9) monthStart = getNewMoonDay(k - 1, timeZone);
            return monthStart;
        }

        function getLeapMonthOffset(a11, timeZone) {
            let k = INT((a11 - 2415021.076998695) / 29.530588853);
            let last = 0; let i = 1;
            let arc = getSunLongitude(getNewMoonDay(k + i, timeZone), timeZone);
            do {
                last = arc; i++; arc = getSunLongitude(getNewMoonDay(k + i, timeZone), timeZone);
            } while (arc != last && i < 14);
            return i - 1;
        }

        function convertSolar2Lunar(dd, mm, yy, timeZone = 7) {
            let k, dayNumber, monthStart, a11, b11, lunarDay, lunarMonth, lunarYear, lunarLeap;
            dayNumber = getJulianDay(dd, mm, yy);
            k = INT((dayNumber - 2415021.076998695) / 29.530588853);
            monthStart = getNewMoonDay(k + 1, timeZone);
            if (monthStart > dayNumber) monthStart = getNewMoonDay(k, timeZone);
            a11 = getLunarMonth11(yy, timeZone);
            b11 = a11;
            if (a11 >= monthStart) { lunarYear = yy; a11 = getLunarMonth11(yy - 1, timeZone); } 
            else { lunarYear = yy + 1; b11 = getLunarMonth11(yy + 1, timeZone); }
            lunarDay = dayNumber - monthStart + 1;
            let diff = INT((monthStart - a11) / 29);
            lunarLeap = 0; lunarMonth = diff + 11;
            if (b11 - a11 > 365) {
                let leapMonthDiff = getLeapMonthOffset(a11, timeZone);
                if (diff >= leapMonthDiff) {
                    lunarMonth = diff + 10;
                    if (diff == leapMonthDiff) lunarLeap = 1;
                }
            }
            if (lunarMonth > 12) lunarMonth -= 12;
            if (lunarMonth >= 11 && diff < 4) lunarYear -= 1;
            return [lunarDay, lunarMonth, lunarYear, lunarLeap];
        }

        function getCanChiYear(lYear) { return !lYear ? "---" : CAN[(lYear + 6) % 10] + " " + CHI[(lYear + 8) % 12]; }
        function getCanChiDay(jd) { return CAN[(jd + 9) % 10] + " " + CHI[(jd + 1) % 12]; }
        function getCanChiMonth(lMonth, lYear) {
            if (!lMonth || !lYear) return "---";
            const canYearIdx = (lYear + 6) % 10;
            const canStartMonth1 = (canYearIdx * 2 + 2) % 10;
            const currentCanIdx = (canStartMonth1 + (lMonth - 1)) % 10;
            const currentChiIdx = (lMonth + 1) % 12;
            return CAN[currentCanIdx] + " " + CHI[currentChiIdx];
        }
        function getCanChiHour(jd, hourIndex) {
            if (!jd) return "---";
            const canDayIdx = (jd + 9) % 10;
            const startCanHourIdx = (canDayIdx % 5) * 2;
            const currentCanHourIdx = (startCanHourIdx + hourIndex) % 10;
            return CAN[currentCanHourIdx] + " " + CHI[hourIndex];
        }

        function getFullLunarInfo(dd, mm, yy) {
            if(!dd || !mm || !yy) return null;
            let [lDay, lMonth, lYear, leap] = convertSolar2Lunar(dd, mm, yy, 7);
            let jd = getJulianDay(dd, mm, yy);
            return { lDay, lMonth, lYear, leap, jd, canChiYear: getCanChiYear(lYear), canChiMonth: getCanChiMonth(lMonth, lYear), canChiDay: getCanChiDay(jd) };
        }

        // --- 2. QUẢN LÝ STATE ---
        let activeTab = 'chart';
        let palaces = [];
        let centerData = { hoTen: "", nam1: "", nam2: "", thang1: "", thang2: "", ngay1: "", ngay2: "", gio1: "", gio2: "", cuc: "", amDuong: "", menh: "" };
        let solarInput = { day: new Date().getDate(), month: new Date().getMonth() + 1, year: new Date().getFullYear(), hourIndex: 0 };
        let lunarResult = null;

        const centerFields = [
            { label: "Họ tên", key: "hoTen", isSplit: false },
            { label: "Năm", key1: "nam1", key2: "nam2", isSplit: true },
            { label: "Tháng", key1: "thang1", key2: "thang2", isSplit: true }, 
            { label: "Ngày", key1: "ngay1", key2: "ngay2", isSplit: true },
            { label: "Giờ", key1: "gio1", key2: "gio2", isSplit: true },
            { label: "Cục", key: "cuc", isSplit: false },
            { label: "Âm Dương", key: "amDuong", isSplit: false },
            { label: "Mệnh", key: "menh", isSplit: false }
        ];

        function initData() {
            palaces = Array(12).fill(null).map((_, i) => ({
                id: i, row1: ["", "", ""], row2: "", middleLeft: "", middleRight: "", row10: ["", "", ""]
            }));
            centerData = { hoTen: "", nam1: "", nam2: "", thang1: "", thang2: "", ngay1: "", ngay2: "", gio1: "", gio2: "", cuc: "", amDuong: "", menh: "" };
            
            let currentDate = new Date();
            let currentHour = currentDate.getHours();
            solarInput = { 
                day: currentDate.getDate(), month: currentDate.getMonth() + 1, year: currentDate.getFullYear(), 
                hourIndex: currentHour === 23 ? 0 : Math.floor((currentHour + 1) / 2) % 12 
            };
            lunarResult = null;
        }

        // --- 3. HIỂN THỊ GIAO DIỆN ---
        function renderChartGrid() {
            const grid = document.getElementById('chart-grid');
            
            // Chèn Datalist (Combobox) để phục vụ việc Gõ và Chọn cho cả 2 dòng
            let html = `
                <datalist id="heavenly_stems_list">
                    ${CAN.map(opt => `<option value="${opt}">`).join('')}
                </datalist>
                <datalist id="palace_names_list">
                    ${PALACE_NAMES.map(opt => `<option value="${opt}">`).join('')}
                </datalist>
                <datalist id="main_stars_list">
                    ${MAIN_STARS.map(opt => `<option value="${opt}">`).join('')}
                </datalist>
            `;

            gridPositions.forEach((pos, idx) => {
                html += `
                <div class="border-[0.5px] border-black flex flex-col overflow-hidden text-xs bg-[#fdfcf0]" style="grid-row: ${pos.row}; grid-column: ${pos.col}">
                    <div class="flex h-[10%]">
                        <div class="w-1/3 h-full flex items-center justify-center font-bold hover:bg-red-50 focus-within:bg-red-50 transition-colors">
                            <input list="heavenly_stems_list" class="w-[45%] h-full text-right outline-none bg-transparent border-none p-0 m-0 palace-input" data-idx="${idx}" data-field="row1" data-sub="0" placeholder="..." value="${palaces[idx].row1[0]}">
                            <span class="w-[55%] pointer-events-none text-left">.${branches[idx]}</span>
                        </div>
                        <!-- Ô Tên Cung (Cho phép gõ chữ + Chọn Dropdown) -->
                        <input list="palace_names_list" class="w-1/3 h-full text-center font-bold outline-none bg-transparent hover:bg-red-50 focus:bg-red-50 border-none palace-input" data-idx="${idx}" data-field="row1" data-sub="1" placeholder="..." value="${palaces[idx].row1[1]}">
                        <input class="w-1/3 h-full text-center font-bold outline-none bg-transparent hover:bg-red-50 focus:bg-red-50 border-none palace-input" data-idx="${idx}" data-field="row1" data-sub="2" placeholder="..." value="${palaces[idx].row1[2]}">
                    </div>
                    <div class="flex h-[10%] justify-center items-center">
                        <!-- Ô Chính Tinh (Cho phép gõ chữ + Chọn Dropdown 14 sao) -->
                        <input list="main_stars_list" class="w-full h-full text-center font-bold outline-none bg-transparent hover:bg-red-50 focus:bg-red-50 uppercase text-red-700 border-none text-sm palace-input" data-idx="${idx}" data-field="row2" placeholder="..." value="${palaces[idx].row2}">
                    </div>
                    <div class="flex flex-1 overflow-hidden">
                        <textarea class="w-1/2 h-full p-1 resize-none outline-none bg-transparent leading-snug hover:bg-red-50 focus:bg-red-50 scrollbar-hide border-none palace-input" data-idx="${idx}" data-field="middleLeft" placeholder="...">${palaces[idx].middleLeft}</textarea>
                        <textarea class="w-1/2 h-full p-1 resize-none outline-none bg-transparent leading-snug hover:bg-red-50 focus:bg-red-50 scrollbar-hide text-right border-none palace-input" data-idx="${idx}" data-field="middleRight" placeholder="...">${palaces[idx].middleRight}</textarea>
                    </div>
                    <div class="flex h-[10%]">
                        <input class="w-1/3 h-full text-center text-[10px] outline-none bg-transparent hover:bg-red-50 focus:bg-red-50 border-none palace-input" data-idx="${idx}" data-field="row10" data-sub="0" placeholder="..." value="${palaces[idx].row10[0]}">
                        <input class="w-1/3 h-full text-center text-[10px] outline-none bg-transparent hover:bg-red-50 focus:bg-red-50 border-none palace-input" data-idx="${idx}" data-field="row10" data-sub="1" placeholder="..." value="${palaces[idx].row10[1]}">
                        <input class="w-1/3 h-full text-center text-[10px] outline-none bg-transparent hover:bg-red-50 focus:bg-red-50 border-none palace-input" data-idx="${idx}" data-field="row10" data-sub="2" placeholder="..." value="${palaces[idx].row10[2]}">
                    </div>
                </div>`;
            });

            html += `<div class="col-start-2 col-end-4 row-start-2 row-end-4 border border-black p-8 flex flex-col justify-center items-center bg-[#fdfcf0] z-10 overflow-hidden">
                <div class="w-full h-full flex flex-col justify-between py-2"><div class="space-y-1">`;
            
            centerFields.forEach(field => {
                html += `<div class="flex items-center border-b border-gray-100 py-0.5">
                    <label class="w-24 text-sm font-bold text-gray-700 text-left whitespace-nowrap">${field.label}:</label>`;
                if (field.isSplit) {
                    html += `<div class="flex-1 flex gap-2">
                        <input id="center_${field.key1}" class="w-1/2 bg-transparent outline-none text-sm text-gray-900 px-1 font-medium focus:bg-red-50 transition-colors h-7" placeholder="Số..." oninput="handleCenterInput('${field.key1}', this.value)" value="${centerData[field.key1]}">
                        <input id="center_${field.key2}" class="w-1/2 bg-transparent outline-none text-sm text-gray-900 px-1 font-medium focus:bg-red-50 transition-colors h-7" placeholder="Can Chi..." oninput="handleCenterInput('${field.key2}', this.value)" value="${centerData[field.key2]}">
                    </div>`;
                } else {
                    html += `<input id="center_${field.key}" class="flex-1 bg-transparent outline-none text-sm text-gray-900 px-2 font-medium focus:bg-red-50 transition-colors w-full h-7" placeholder="..." oninput="handleCenterInput('${field.key}', this.value)" value="${centerData[field.key]}">`;
                }
                html += `</div>`;
            });
            html += `</div></div></div>`;
            grid.innerHTML = html;

            document.querySelectorAll('.palace-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    let idx = e.target.dataset.idx;
                    let field = e.target.dataset.field;
                    let sub = e.target.dataset.sub;
                    if(sub !== undefined) palaces[idx][field][sub] = e.target.value;
                    else palaces[idx][field] = e.target.value;
                });
            });
        }

        function renderSelectOptions() {
            const select = document.getElementById('solar_hour');
            let html = '';
            GIO_FRAMES.forEach((frame, i) => {
                html += `<option value="${i}" ${solarInput.hourIndex === i ? 'selected' : ''}>${frame}</option>`;
            });
            select.innerHTML = html;
        }

        function fitChartToScreen() {
            if (activeTab !== 'chart') return;
            const wrapper = document.getElementById('chart-wrapper');
            const chart = document.getElementById('export-area');
            if (!wrapper || !chart) return;
            const wWidth = wrapper.clientWidth; const wHeight = wrapper.clientHeight;
            const scale = Math.min(wWidth / 1200, wHeight / 848.5) * 0.98;
            chart.style.transform = `scale(${scale})`;
        }

        function switchTab(tabId) {
            activeTab = tabId;
            document.getElementById('tab-chart').classList.toggle('hidden', tabId !== 'chart');
            document.getElementById('tab-chart').classList.toggle('flex', tabId === 'chart');
            document.getElementById('tab-converter').classList.toggle('hidden', tabId !== 'converter');

            const btnChart = document.getElementById('btn-tab-chart');
            const btnConverter = document.getElementById('btn-tab-converter');

            if (tabId === 'chart') {
                btnChart.className = "flex items-center gap-2 px-5 py-2 rounded-lg transition-all bg-[#fdfcf0] shadow text-red-800 font-bold";
                btnConverter.className = "flex items-center gap-2 px-5 py-2 rounded-lg transition-all text-gray-500 hover:text-gray-700";
                setTimeout(fitChartToScreen, 10);
            } else {
                btnConverter.className = "flex items-center gap-2 px-5 py-2 rounded-lg transition-all bg-[#fdfcf0] shadow text-red-800 font-bold";
                btnChart.className = "flex items-center gap-2 px-5 py-2 rounded-lg transition-all text-gray-500 hover:text-gray-700";
            }
        }

        function handleCenterInput(key, value) {
            centerData[key] = value;
            if (['nam1', 'thang1', 'ngay1'].includes(key)) syncToConverter();
        }

        function handleSolarInput(key, value) {
            solarInput[key] = parseInt(value) || 0;
            updateConverterUI();
        }

        function syncToConverter() {
            let d = parseInt(centerData.ngay1) || 0; let m = parseInt(centerData.thang1) || 0; let y = parseInt(centerData.nam1) || 0;
            if (d > 0 || m > 0 || y > 0) {
                solarInput.day = d || solarInput.day; solarInput.month = m || solarInput.month; solarInput.year = y || solarInput.year;
                updateConverterUI();
            }
        }

        function updateConverterUI() {
            document.getElementById('solar_day').value = solarInput.day || "";
            document.getElementById('solar_month').value = solarInput.month || "";
            document.getElementById('solar_year').value = solarInput.year || "";
            document.getElementById('solar_hour').value = solarInput.hourIndex;

            lunarResult = getFullLunarInfo(solarInput.day, solarInput.month, solarInput.year);

            if(lunarResult) {
                let canChiHour = getCanChiHour(lunarResult.jd, solarInput.hourIndex);
                document.getElementById('res_canChiYear').innerText = lunarResult.canChiYear;
                document.getElementById('res_canChiMonth').innerText = `${lunarResult.canChiMonth} (Tháng ${lunarResult.lMonth}${lunarResult.leap ? ' Nhuận' : ''})`;
                document.getElementById('res_canChiDay').innerText = `${lunarResult.canChiDay} (Ngày ${lunarResult.lDay})`;
                document.getElementById('res_gioChi').innerText = "Giờ " + canChiHour;
            } else {
                document.getElementById('res_canChiYear').innerText = "---";
                document.getElementById('res_canChiMonth').innerText = "---";
                document.getElementById('res_canChiDay').innerText = "---";
                document.getElementById('res_gioChi').innerText = "---";
            }
        }

        function applyToChart() {
            if (!lunarResult) return;
            const frame = GIO_FRAMES[solarInput.hourIndex];
            const timeRange = frame.substring(frame.indexOf('(') + 1, frame.indexOf(')'));
            let canChiHour = getCanChiHour(lunarResult.jd, solarInput.hourIndex);

            centerData.nam1 = lunarResult.lYear.toString(); centerData.nam2 = lunarResult.canChiYear;
            centerData.thang1 = lunarResult.lMonth.toString() + (lunarResult.leap ? ' Nhuận' : ''); centerData.thang2 = lunarResult.canChiMonth;
            centerData.ngay1 = lunarResult.lDay.toString(); centerData.ngay2 = lunarResult.canChiDay;
            centerData.gio1 = timeRange; centerData.gio2 = "Giờ " + canChiHour;
            centerData.amDuong = (lunarResult.lYear % 2 === 0 ? "Dương" : "Âm") + " Nam/Nữ";

            ['nam1', 'nam2', 'thang1', 'thang2', 'ngay1', 'ngay2', 'gio1', 'gio2', 'amDuong'].forEach(key => {
                const el = document.getElementById('center_' + key);
                if(el) el.value = centerData[key];
            });
            switchTab('chart');
        }

        function triggerPrint() {
            // Kiểm tra: Nếu đang ở Tab Đổi Lịch, tự động chuyển về Tab Lá Số trước khi xuất
            if (activeTab !== 'chart') {
                switchTab('chart');
                // Chờ giao diện render và animation chuyển tab hoàn tất (400ms) rồi mới chụp
                setTimeout(() => performPDFExport(), 400);
            } else {
                performPDFExport();
            }
        }

        function performPDFExport() {
            const element = document.getElementById('export-area');
            const wrapper = document.getElementById('chart-wrapper');
            const btn = document.getElementById('btn-print');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = `<i data-lucide="loader" class="w-5 h-5 animate-spin"></i> Đang tải...`;
            lucide.createIcons();

            // Ghi nhớ trạng thái layout hiện tại
            const currentTransform = element.style.transform;
            const currentAlign = wrapper.style.alignItems;
            const currentJustify = wrapper.style.justifyContent;
            const currentOverflow = wrapper.style.overflow;

            // Đưa element về tỷ lệ gốc và dời về góc trái trên để html2canvas không bị lẹm tọa độ
            element.style.transform = 'scale(1)';
            wrapper.style.alignItems = 'flex-start';
            wrapper.style.justifyContent = 'flex-start';
            wrapper.style.overflow = 'visible';

            const inputs = element.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (input.tagName.toLowerCase() === 'textarea') {
                    input.innerHTML = input.value;
                } else if (input.tagName.toLowerCase() === 'select') {
                    Array.from(input.options).forEach(opt => opt.removeAttribute('selected'));
                    if (input.selectedIndex >= 0) {
                        input.options[input.selectedIndex].setAttribute('selected', 'selected');
                    }
                } else {
                    input.setAttribute('value', input.value);
                }
            });

            element.classList.remove('shadow-2xl');

            const name = centerData.hoTen ? centerData.hoTen.trim().replace(/\s+/g, '_') : 'VoDanh';
            const filename = `La_So_${name}.pdf`;

            // Khai báo rõ kích thước cố định cần chụp
            const opt = {
                margin:       0, 
                filename:     filename, 
                image:        { type: 'jpeg', quality: 1 },
                html2canvas:  { 
                    scale: 2, 
                    useCORS: true,
                    scrollX: 0,
                    scrollY: 0,
                    width: 1200,
                    height: 848.5
                }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };

            // Đợi DOM cập nhật layout (300ms) rồi tiến hành chụp
            setTimeout(() => {
                html2pdf().set(opt).from(element).save().then(() => {
                    // Phục hồi lại giao diện trung tâm
                    element.style.transform = currentTransform; 
                    wrapper.style.alignItems = currentAlign;
                    wrapper.style.justifyContent = currentJustify;
                    wrapper.style.overflow = currentOverflow;
                    element.classList.add('shadow-2xl'); 
                    btn.innerHTML = originalText; 
                    lucide.createIcons();
                }).catch(err => {
                    console.error("Lỗi xuất PDF:", err);
                    element.style.transform = currentTransform; 
                    wrapper.style.alignItems = currentAlign;
                    wrapper.style.justifyContent = currentJustify;
                    wrapper.style.overflow = currentOverflow;
                    element.classList.add('shadow-2xl');
                    btn.innerHTML = originalText; 
                    lucide.createIcons(); 
                    alert("Có lỗi xảy ra khi xuất PDF!");
                });
            }, 300); 
        }

        function showResetModal() { document.getElementById('confirmModal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('confirmModal').classList.add('hidden'); }
        function executeReset() { initData(); renderChartGrid(); updateConverterUI(); closeModal(); fitChartToScreen(); }

        document.addEventListener('DOMContentLoaded', () => {
            initData(); renderChartGrid(); renderSelectOptions(); updateConverterUI(); lucide.createIcons(); 
            window.addEventListener('resize', fitChartToScreen); setTimeout(fitChartToScreen, 50);
        });
    </script>
</body>
</html>